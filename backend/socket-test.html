<!DOCTYPE html>
<html>
  <head>
    <title>Harmony WebSocket Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
      }
      #messages {
        border: 1px solid #ccc;
        height: 400px;
        overflow-y: auto;
        padding: 10px;
        margin-bottom: 20px;
        background: #f5f5f5;
      }
      .message {
        margin: 5px 0;
        padding: 8px;
        background: white;
        border-radius: 4px;
      }
      .system {
        color: #666;
        font-style: italic;
      }
      input,
      button {
        padding: 10px;
        margin: 5px;
      }
      input {
        width: 300px;
      }
      .controls {
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <h1>Harmony WebSocket Test</h1>

    <div class="controls">
      <h3>1. Authenticate</h3>
      <input
        type="text"
        id="email"
        placeholder="Email"
        value="test@example.com"
      />
      <input
        type="password"
        id="password"
        placeholder="Password"
        value="password123"
      />
      <button onclick="login()">Login</button>
    </div>

    <div class="controls">
      <h3>2. Connect WebSocket</h3>
      <button onclick="connectWs()" id="connectBtn">Connect WebSocket</button>
      <button onclick="disconnectWs()" id="disconnectBtn" disabled>
        Disconnect
      </button>
    </div>

    <div class="controls">
      <h3>3. Subscribe to Channel</h3>
      <input type="text" id="channelId" placeholder="Channel ID" />
      <button onclick="subscribe()">Subscribe</button>
      <button onclick="unsubscribe()">Unsubscribe</button>
    </div>

    <h3>Messages</h3>
    <div id="messages"></div>

    <script>
      let ws = null;
      let token = null;

      async function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          const response = await fetch("http://localhost:8000/api/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();
          token = data.token;
          addMessage("Logged in successfully!", "system");
          console.log("Token:", token);
        } catch (error) {
          addMessage("Login failed: " + error.message, "system");
        }
      }

      function connectWs() {
        if (!token) {
          addMessage("Please login first!", "system");
          return;
        }

        ws = new WebSocket(`ws://localhost:8000/ws?token=${token}`);

        ws.onopen = () => {
          addMessage("WebSocket connected!", "system");
          document.getElementById("connectBtn").disabled = true;
          document.getElementById("disconnectBtn").disabled = false;
        };

        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          console.log("Received:", data);

          switch (data.type) {
            case "message_created":
              addMessage(`${data.username}: ${data.content}`, "message");
              break;
            case "subscribed":
              addMessage(`Subscribed to channel: ${data.channel_id}`, "system");
              break;
            case "unsubscribed":
              addMessage(
                `Unsubscribed from channel: ${data.channel_id}`,
                "system"
              );
              break;
            case "error":
              addMessage(`Error: ${data.message}`, "system");
              break;
          }
        };

        ws.onclose = () => {
          addMessage("WebSocket disconnected", "system");
          document.getElementById("connectBtn").disabled = false;
          document.getElementById("disconnectBtn").disabled = true;
        };

        ws.onerror = (error) => {
          addMessage("WebSocket error: " + error, "system");
        };
      }

      function disconnectWs() {
        if (ws) {
          ws.close();
        }
      }

      function subscribe() {
        const channelId = document.getElementById("channelId").value;
        if (!channelId) {
          addMessage("Please enter a channel ID", "system");
          return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket not connected", "system");
          return;
        }

        ws.send(
          JSON.stringify({
            type: "subscribe",
            channel_id: channelId,
          })
        );
      }

      function unsubscribe() {
        const channelId = document.getElementById("channelId").value;
        if (!channelId) {
          addMessage("Please enter a channel ID", "system");
          return;
        }

        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addMessage("WebSocket not connected", "system");
          return;
        }

        ws.send(
          JSON.stringify({
            type: "unsubscribe",
            channel_id: channelId,
          })
        );
      }

      function addMessage(text, className = "message") {
        const messagesDiv = document.getElementById("messages");
        const messageEl = document.createElement("div");
        messageEl.className = className;
        messageEl.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        messagesDiv.appendChild(messageEl);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    </script>
  </body>
</html>
